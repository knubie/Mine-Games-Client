// Generated by CoffeeScript 1.3.2
var onBodyLoad, onDeviceReady, preventBehavior, server_url,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

server_url = "http://localhost:3000";

preventBehavior = function(e) {
  return e.preventDefault();
};

document.addEventListener("touchmove", preventBehavior, false);

onBodyLoad = function() {
  return document.addEventListener("deviceready", onDeviceReady, false);
};

onDeviceReady = function() {
  return $(function() {
    var CardListView, Deck, Decks, LobbyView, Match, MatchListView, MatchView, Matches, cards, facebook_auth, lobby, templates;
    templates = {
      LobbyMatchListItem: function(id, players) {
        var player;
        return "<li><a href='#match' class='match-list-item' data-transition='slide' data-id='" + id + "'>" + ((function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = players.length; _i < _len; _i++) {
            player = players[_i];
            _results.push(player.username);
          }
          return _results;
        })()) + "</a></li>";
      },
      CardListItem: function(name, desc) {
        return "<li><a href='#card-detail' class='card-list-item' data-transition='slide'><img src='" + name + "_thumb.png' alt='' />" + name + desc + "</a></li>";
      }
    };
    cards = {
      'stone pickaxe': {
        short_desc: '+1 card from the mine',
        long_desc: 'Draw one card from the Mineshaft and add it to your hand.'
      },
      'copper': {
        short_desc: '+$1',
        long_desc: 'Worth $1 at the shop.'
      }
    };
    Match = (function(_super) {

      __extends(Match, _super);

      function Match() {
        return Match.__super__.constructor.apply(this, arguments);
      }

      return Match;

    })(Backbone.Model);
    Matches = (function(_super) {

      __extends(Matches, _super);

      function Matches() {
        return Matches.__super__.constructor.apply(this, arguments);
      }

      Matches.prototype.initialize = function() {
        return this.fetch();
      };

      Matches.prototype.url = "" + server_url + "/matches";

      Matches.prototype.model = Match;

      return Matches;

    })(Backbone.Collection);
    Deck = (function(_super) {

      __extends(Deck, _super);

      function Deck() {
        return Deck.__super__.constructor.apply(this, arguments);
      }

      return Deck;

    })(Backbone.Model);
    Decks = (function(_super) {

      __extends(Decks, _super);

      function Decks() {
        return Decks.__super__.constructor.apply(this, arguments);
      }

      Decks.prototype.initialize = function() {
        return this.fetch();
      };

      Decks.prototype.model = Deck;

      Decks.prototype.url = "" + server_url + "/decks";

      return Decks;

    })(Backbone.Collection);
    LobbyView = (function(_super) {

      __extends(LobbyView, _super);

      function LobbyView() {
        this.render = __bind(this.render, this);
        return LobbyView.__super__.constructor.apply(this, arguments);
      }

      LobbyView.prototype.initialize = function(matches, decks) {
        this.matches = matches;
        this.decks = decks;
        return this.render();
      };

      LobbyView.prototype.el = '#lobby';

      LobbyView.prototype.events = {
        'click #refresh_lobby': 'refresh'
      };

      LobbyView.prototype.render = function() {
        var _this = this;
        return this.matches.on('reset', function() {
          return _this.decks.on('reset', function() {
            var match, _i, _len, _ref, _results;
            console.log('iterating...');
            _ref = _this.matches.models;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              match = _ref[_i];
              _results.push((function(match) {
                var deck, view;
                console.log(match);
                deck = _this.decks.where({
                  match_id: match.get('id')
                });
                view = new MatchListView(match, deck[0]);
                return _this.$el.find('#matches').append(view.el).listview('refresh');
              })(match));
            }
            return _results;
          });
        });
      };

      LobbyView.prototype.refresh = function() {
        this.matches.fetch({
          add: true
        });
        return this.decks.fetch({
          add: true
        });
      };

      return LobbyView;

    })(Backbone.View);
    MatchListView = (function(_super) {

      __extends(MatchListView, _super);

      function MatchListView() {
        return MatchListView.__super__.constructor.apply(this, arguments);
      }

      MatchListView.prototype.initialize = function(match, deck) {
        this.match = match;
        this.deck = deck;
        return this.el = templates.LobbyMatchListItem(this.match.get('id'), this.match.get('players'));
      };

      MatchListView.prototype.events = {
        'click': 'render_match'
      };

      MatchListView.prototype.render_match = function() {
        var view;
        view = new MatchView(this.match, this.deck);
        view.match = this.match;
        view.deck = this.deck;
        return view.render();
      };

      return MatchListView;

    })(Backbone.View);
    MatchView = (function(_super) {

      __extends(MatchView, _super);

      function MatchView() {
        return MatchView.__super__.constructor.apply(this, arguments);
      }

      MatchView.prototype.initialize = function(match, deck) {
        this.match = match;
        this.deck = deck;
      };

      MatchView.prototype.el = '#match';

      MatchView.prototype.render = function() {
        var card, _i, _len, _ref, _results;
        _ref = this.deck.hand;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          card = _ref[_i];
          _results.push((function(card) {
            var view;
            view = new CardListView;
            return $el.find('#hand').append(view.el);
          })(card));
        }
        return _results;
      };

      return MatchView;

    })(Backbone.View);
    CardListView = (function(_super) {

      __extends(CardListView, _super);

      function CardListView() {
        return CardListView.__super__.constructor.apply(this, arguments);
      }

      CardListView.prototype.events = {
        'click': 'render_card'
      };

      CardListView.prototype.render_card = function() {};

      return CardListView;

    })(Backbone.View);
    facebook_auth = function(callback) {
      window.plugins.childBrowser.showWebPage("" + server_url + "/auth/facebook?display=touch");
      return window.plugins.childBrowser.onLocationChange = function(loc) {
        var access_token;
        if (/access_token/.test(loc)) {
          access_token = unescape(loc).split("access_token/")[1];
          $.cookie("token", access_token, {
            expires: 7300
          });
          window.plugins.childBrowser.close();
          return callback();
        }
      };
    };
    if ($.cookie("token") != null) {
      $.mobile.changePage("#lobby", {
        transition: "none"
      });
      lobby = new LobbyView(new Matches, new Decks);
    }
    $("#facebook-auth").on('tap', function() {
      console.log('clicked facebook');
      return facebook_auth(function() {
        return $.mobile.changePage("#lobby", {
          transition: "none"
        });
      });
    });
    $('#login-form').submit(function(e) {
      $.post("" + server_url + "/signin.json", $(this).serialize(), function(user) {
        if (user.error != null) {
          return alert('invalid username and/or password');
        } else {
          $.cookie('token', user.token);
          return $.mobile.changePage('#lobby', {
            transition: 'slidedown'
          });
        }
      }, 'json');
      return e.preventDefault();
    });
    $('#signup-form').submit(function(e) {
      $.post("" + server_url + "/users.json", $(this).serialize(), function(user) {
        if (user.error != null) {
          return alert('error');
        } else {
          $.cookie('token', user.token);
          return $.mobile.changePage('#lobby', {
            transition: 'slidedown'
          });
        }
      }, 'json');
      return e.preventDefault();
    });
    $('.logout').click(function() {
      $.cookie('token', null);
      return $.mobile.changePage("#home", {
        transition: "flip"
      });
    });
    $('#lobby').on('pageinit', function() {});
    $('#refresh_lobby').click(function() {});
    $('#new_match_facebook').on('pageshow', function() {
      return $.getJSON("" + server_url + "/friends.json", function(data) {
        var friend, list, _i, _len, _ref, _results;
        $("#play_friends").html('');
        list = function(friend, type) {
          return $("#" + type).append("<label><input id='users_' name='users[]' type='checkbox' value='" + friend.id + "'>" + friend.name + "</label>").trigger('create');
        };
        _ref = data.play_friends;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          friend = _ref[_i];
          _results.push(list(friend, 'play_friends'));
        }
        return _results;
      });
    });
    return $('#new-match-username-form').submit(function(e) {
      $.post("" + server_url + "/matches.json", $(this).serialize(), function(data) {
        var error, _i, _len, _ref, _results;
        if (data.errors.length > 0) {
          _ref = data.errors;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            error = _ref[_i];
            _results.push(alert(error));
          }
          return _results;
        } else {
          return alert("match created");
        }
      }, 'json');
      return e.preventDefault();
    });
  });
};
